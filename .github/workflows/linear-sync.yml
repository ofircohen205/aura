name: Linear Issue Sync

on:
  pull_request:
    types: [opened, synchronize, closed, reopened]
  push:
    branches:
      - main

jobs:
  sync-linear:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Linear Issue ID
        id: extract_issue
        uses: actions/github-script@v7
        with:
          script: |
            // Safely extract Linear issue ID from PR body using JavaScript
            // This avoids shell interpretation of file paths or special characters
            const prBody = context.payload.pull_request.body || '';
            const branchName = context.payload.pull_request.head.ref || '';

            // Extract AURA-XXX pattern from PR body
            const bodyMatch = prBody.match(/AURA-\d+/);
            let issueId = bodyMatch ? bodyMatch[0] : null;

            // If not found in body, try branch name
            if (!issueId) {
              const branchMatch = branchName.match(/AURA-\d+/);
              issueId = branchMatch ? branchMatch[0] : null;
            }

            if (issueId) {
              core.setOutput('issue_id', issueId);
              console.log(`Found Linear issue: ${issueId}`);
            } else {
              core.setOutput('issue_id', '');
              console.log('No Linear issue ID found in PR body or branch name');
            }

      - name: Update Linear Issue Status
        if: steps.extract_issue.outputs.issue_id != ''
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          ISSUE_ID="${{ steps.extract_issue.outputs.issue_id }}"
          PR_STATE="${{ github.event.pull_request.state }}"
          PR_MERGED="${{ github.event.pull_request.merged }}"

          # Determine Linear status based on PR state
          if [ "$PR_MERGED" == "true" ]; then
            LINEAR_STATUS="Done"
          elif [ "$PR_STATE" == "open" ]; then
            LINEAR_STATUS="In Review"
          else
            LINEAR_STATUS="In Progress"
          fi

          if [ -n "$LINEAR_API_KEY" ]; then
            echo "Updating Linear issue $ISSUE_ID to status: $LINEAR_STATUS"
            echo "Note: Linear API integration not yet implemented."
            echo "To implement, add GraphQL mutations here using the LINEAR_API_KEY."
          else
            echo "Linear issue: $ISSUE_ID"
            echo "Suggested status: $LINEAR_STATUS"
            echo ""
            echo "‚ÑπÔ∏è  No LINEAR_API_KEY found. The workflow will still:"
            echo "   - Extract and display the issue ID"
            echo "   - Comment on the PR with a link"
            echo ""
            echo "To enable automatic status updates:"
            echo "  1. Get your Linear API key from: https://linear.app/settings/api"
            echo "  2. Add it to GitHub Secrets as LINEAR_API_KEY"
            echo ""
            echo "Note: Personal Linear-GitHub integration doesn't automatically"
            echo "      give GitHub Actions access. You need a separate API key."
          fi

      - name: Comment on PR
        if: steps.extract_issue.outputs.issue_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueId = '${{ steps.extract_issue.outputs.issue_id }}';
            const prNumber = context.payload.pull_request.number;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîó Linked to Linear issue: **${issueId}**\n\nView in Linear: https://linear.app/ofircohen/issue/${issueId}`
            });
